<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DORA CTPP Designation Probability Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .question-section {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .result-card {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            color: white;
        }
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-shield-alt text-4xl text-blue-600 mr-4"></i>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">DORA CTPP Assessment Tool</h1>
                    <p class="text-gray-600">Critical Third-Party Provider Designation Probability Calculator</p>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                <div id="progressBar" class="bg-blue-600 h-3 rounded-full progress-bar" style="width: 0%"></div>
            </div>
            <p class="text-center text-sm text-gray-600">Complete the assessment to determine your CTPP designation probability</p>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                <div>
                    <h3 class="text-lg font-medium text-blue-800 mb-2">How This Assessment Works</h3>
                    <p class="text-blue-700 text-sm mb-2">This tool evaluates your probability of being designated as a Critical Third-Party Provider (CTPP) under the EU's Digital Operational Resilience Act (DORA).</p>
                    <p class="text-blue-700 text-sm">The assessment follows the official criteria from Commission Delegated Regulation (EU) 2024/1502 and uses a two-step approach: quantitative thresholds followed by qualitative evaluation.</p>
                </div>
            </div>
        </div>

        <!-- Assessment Form -->
        <form id="assessmentForm" class="space-y-6">
            <!-- Section 1: Basic Information -->
            <div class="bg-white rounded-lg shadow-lg p-6 question-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-building text-blue-600 mr-3"></i>
                    1. Basic Company Information
                </h2>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                        <input type="text" id="companyName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Your ICT service provider name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Primary ICT Services Provided 
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">Examples: Cloud computing, data processing, software services, cybersecurity, payment processing, data analytics, IT infrastructure management</span>
                            </span>
                        </label>
                        <select id="primaryService" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select primary service</option>
                            <option value="cloud">Cloud Computing & Infrastructure</option>
                            <option value="data">Data Processing & Analytics</option>
                            <option value="software">Software Services & Applications</option>
                            <option value="cybersecurity">Cybersecurity Services</option>
                            <option value="payment">Payment Processing</option>
                            <option value="other">Other ICT Services</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 2: Market Share & Financial Entity Coverage -->
            <div class="bg-white rounded-lg shadow-lg p-6 question-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-blue-600 mr-3"></i>
                    2. Market Coverage Analysis
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">How many financial institutions do you serve in each category?</h3>
                        <p class="text-sm text-gray-600 mb-4">Provide the number of clients in each category. This helps determine if you serve at least 10% of any category (a key threshold for CTPP designation).</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Credit Institutions (Banks)
                                    <span class="tooltip">
                                        <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                        <span class="tooltiptext">Traditional banks, cooperative banks, savings banks, and other institutions authorized to take deposits and provide credit</span>
                                    </span>
                                </label>
                                <input type="number" id="creditInstitutions" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of banks served" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Investment Firms
                                    <span class="tooltip">
                                        <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                        <span class="tooltiptext">Securities firms, brokers, asset managers, investment advisors, and portfolio management companies</span>
                                    </span>
                                </label>
                                <input type="number" id="investmentFirms" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of investment firms served" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Insurance Companies
                                    <span class="tooltip">
                                        <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                        <span class="tooltiptext">Life insurance, non-life insurance, and reinsurance companies</span>
                                    </span>
                                </label>
                                <input type="number" id="insuranceCompanies" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of insurers served" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Payment Institutions
                                    <span class="tooltip">
                                        <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                        <span class="tooltiptext">Money transfer services, electronic money institutions, payment processors, and fintech payment companies</span>
                                    </span>
                                </label>
                                <input type="number" id="paymentInstitutions" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of payment institutions served" min="0">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">What is the combined total value of assets of all your financial clients?</h3>
                        <p class="text-sm text-gray-600 mb-3">This helps determine if you serve institutions representing at least 10% of total EU financial sector assets.</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Assets Under Management/Custody (EUR billions)</label>
                                <input type="number" id="totalAssets" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="e.g., 50 (for €50 billion)" min="0" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estimated % of EU Financial Sector You Serve</label>
                                <input type="number" id="marketSharePercent" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="e.g., 5 (for 5%)" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Systemically Important Institutions -->
            <div class="bg-white rounded-lg shadow-lg p-6 question-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-university text-blue-600 mr-3"></i>
                    3. Systemically Important Client Assessment
                </h2>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <p class="text-yellow-800 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Critical Factor:</strong> Serving even one G-SII or three O-SIIs can significantly increase your CTPP designation probability.</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Global Systemically Important Institutions (G-SIIs)
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">The largest, most interconnected banks globally (e.g., BNP Paribas, Deutsche Bank, Santander, ING). These are identified by international regulators as critical to global financial stability.</span>
                            </span>
                        </label>
                        <input type="number" id="gsiis" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of G-SIIs you serve" min="0">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Other Systemically Important Institutions (O-SIIs)
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">Large regional banks identified by national authorities as important for their domestic financial system. Each EU country designates its own O-SIIs.</span>
                            </span>
                        </label>
                        <input type="number" id="osiis" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of O-SIIs you serve" min="0">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Do you serve any O-SII with a systemic score above 3000?
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">This refers to the O-SII buffer calculation score. Banks with scores above 3000 are considered highly systemic. Check with your bank clients or regulatory publications.</span>
                            </span>
                        </label>
                        <select id="highScoreOsii" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select answer</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                            <option value="unknown">Unknown/Not sure</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Other Systemically Important Non-Bank Financial Entities
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">Large insurance companies, major asset managers, significant payment institutions, or other financial entities designated as systemically important by regulators</span>
                            </span>
                        </label>
                        <input type="number" id="systemicNonBank" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Number of systemic non-bank entities served" min="0">
                    </div>
                </div>
            </div>

            <!-- Section 4: Service Criticality -->
            <div class="bg-white rounded-lg shadow-lg p-6 question-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cogs text-blue-600 mr-3"></i>
                    4. Service Criticality Assessment
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            What types of critical business functions do your ICT services support?
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">Critical functions are essential business activities that, if disrupted, would significantly impact the financial institution's ability to serve customers or meet regulatory requirements</span>
                            </span>
                        </label>
                        <div class="grid md:grid-cols-2 gap-2">
                            <label class="flex items-center p-2 border rounded hover:bg-gray-50">
                                <input type="checkbox" name="criticalFunctions" value="payment" class="mr-2">
                                <span class="text-sm">Payment processing and settlement</span>
                            </label>
                            <label class="flex items-center p-2 border rounded hover:bg-gray-50">
                                <input type="checkbox" name="criticalFunctions" value="trading" class="mr-2">
                                <span class="text-sm">Trading and market operations</span>
                            </label>
                            <label class="flex items-center p-2 border rounded hover:bg-gray-50">
                                <input type="checkbox" name="criticalFunctions" value="lending" class="mr-2">
                                <span class="text-sm">Lending and credit operations</span>
                            </label>
                            <label class="flex items-center p-2 border rounded hover:bg-gray-50">
                                <input type="checkbox" name="criticalFunctions" value="custody" class="mr-2">
                                <span class="text-sm">Asset custody and safekeeping</span>
                            </label>
                            <label class="flex items-center p-2 border rounded hover:bg-gray-50">
                                <input type="checkbox" name="criticalFunctions" value="risk" class="mr-2">
                                <span class="text-sm">Risk management systems</span>
                            </label>
                            <label class="flex items-center p-2 border rounded hover:bg-gray-50">
                                <input type="checkbox" name="criticalFunctions" value="compliance" class="mr-2">
                                <span class="text-sm">Regulatory reporting and compliance</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            If your services became unavailable, how quickly would it impact your clients' operations?
                        </label>
                        <select id="impactSpeed" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select timeframe</option>
                            <option value="immediate">Immediately (within minutes)</option>
                            <option value="hours">Within hours</option>
                            <option value="days">Within days</option>
                            <option value="weeks">Within weeks</option>
                            <option value="minimal">Minimal impact</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 5: Substitutability -->
            <div class="bg-white rounded-lg shadow-lg p-6 question-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-exchange-alt text-blue-600 mr-3"></i>
                    5. Service Substitutability & Market Competition
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            How many of your clients could easily switch to a competitor with similar capacity and capabilities?
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">Consider factors like: available alternatives, technical compatibility, regulatory approvals, capacity constraints of competitors</span>
                            </span>
                        </label>
                        <select id="alternativeAvailability" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select percentage</option>
                            <option value="0-10">0-10% (Very few alternatives)</option>
                            <option value="10-25">10-25% (Limited alternatives)</option>
                            <option value="25-50">25-50% (Some alternatives)</option>
                            <option value="50-75">50-75% (Many alternatives)</option>
                            <option value="75-100">75-100% (Abundant alternatives)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            For how many of your clients would switching to another provider be highly difficult or costly?
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">Consider: data migration complexity, integration challenges, regulatory approvals needed, training requirements, contractual obligations</span>
                            </span>
                        </label>
                        <select id="migrationDifficulty" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select percentage</option>
                            <option value="75-100">75-100% (Very difficult to switch)</option>
                            <option value="50-75">50-75% (Difficult to switch)</option>
                            <option value="25-50">25-50% (Moderately difficult)</option>
                            <option value="10-25">10-25% (Somewhat difficult)</option>
                            <option value="0-10">0-10% (Easy to switch)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            What is the typical time and cost for a client to migrate to another provider?
                        </label>
                        <div class="grid md:grid-cols-2 gap-4">
                            <select id="migrationTime" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="">Migration timeframe</option>
                                <option value="weeks">Few weeks</option>
                                <option value="months">Few months</option>
                                <option value="6-12months">6-12 months</option>
                                <option value="years">1+ years</option>
                                <option value="very-difficult">Extremely difficult/unlikely</option>
                            </select>
                            <select id="migrationCost" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="">Migration cost impact</option>
                                <option value="low">Low cost (< 5% of annual IT budget)</option>
                                <option value="moderate">Moderate cost (5-15% of annual IT budget)</option>
                                <option value="high">High cost (15-30% of annual IT budget)</option>
                                <option value="very-high">Very high cost (> 30% of annual IT budget)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Interconnectedness & Dependencies -->
            <div class="bg-white rounded-lg shadow-lg p-6 question-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-network-wired text-blue-600 mr-3"></i>
                    6. System Interconnectedness & Dependencies
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Do your clients have significant business relationships with each other?
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">For example: banks that lend to each other, asset managers using the same custodian, payment processors serving the same merchants</span>
                            </span>
                        </label>
                        <select id="clientInterconnection" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select level of interconnection</option>
                            <option value="high">High - Many clients are interconnected</option>
                            <option value="moderate">Moderate - Some interconnections exist</option>
                            <option value="low">Low - Clients are mostly independent</option>
                            <option value="none">None - No significant interconnections</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Do you rely on subcontractors or third-party providers for delivering services to financial entities?
                            <span class="tooltip">
                                <i class="fas fa-question-circle text-blue-500 ml-1"></i>
                                <span class="tooltiptext">This includes cloud infrastructure providers, data centers, specialized software vendors, or other service providers critical to your operations</span>
                            </span>
                        </label>
                        <select id="subcontractorDependency" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select dependency level</option>
                            <option value="critical">Critical - Cannot operate without key subcontractors</option>
                            <option value="significant">Significant - Heavily dependent on subcontractors</option>
                            <option value="moderate">Moderate - Some dependency on subcontractors</option>
                            <option value="minimal">Minimal - Limited use of subcontractors</option>
                            <option value="none">None - No subcontractor dependencies</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            What would be the broader market impact if your services were disrupted?
                        </label>
                        <select id="marketImpact" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="">Select impact level</option>
                            <option value="systemic">Systemic - Would affect broader financial markets</option>
                            <option value="sector">Sector-wide - Would impact multiple financial institutions</option>
                            <option value="regional">Regional - Would affect specific geographic areas</option>
                            <option value="limited">Limited - Impact mostly contained to direct clients</option>
                            <option value="minimal">Minimal - Little broader impact</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <div class="text-center">
                <button type="button" id="calculateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    <i class="fas fa-calculator mr-2"></i>Calculate CTPP Designation Probability
                </button>
            </div>
        </form>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden mt-8 space-y-6">
            <!-- Overall Result Card -->
            <div class="result-card rounded-lg shadow-xl p-8 text-center">
                <div class="mb-6">
                    <div class="text-6xl font-bold mb-2" id="probabilityScore">--%</div>
                    <div class="text-xl opacity-90">CTPP Designation Probability</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-lg font-semibold mb-2">Risk Assessment</div>
                    <div id="riskLevel" class="text-2xl font-bold">--</div>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-600 mr-3"></i>
                    Detailed Assessment Breakdown
                </h3>
                
                <!-- Step 1 Criteria Results -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Step 1: Quantitative Criteria (Must ALL be met)</h4>
                    <div class="space-y-3" id="step1Results">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Step 2 Criteria Results -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Step 2: Qualitative Assessment</h4>
                    <div class="space-y-3" id="step2Results">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Probability Chart -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Probability Breakdown</h4>
                    <div style="height: 300px;" class="relative">
                        <canvas id="probabilityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                    Recommendations & Next Steps
                </h3>
                <div id="recommendations" class="space-y-4">
                    <!-- Recommendations will be populated by JavaScript -->
                </div>
            </div>

            <!-- Legal Disclaimer -->
            <div class="bg-gray-100 border border-gray-300 rounded-lg p-4">
                <p class="text-xs text-gray-600">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Disclaimer:</strong> This assessment tool provides an indicative probability based on the criteria established in Commission Delegated Regulation (EU) 2024/1502. The actual designation decision rests solely with the European Supervisory Authorities (ESAs). This tool is for informational purposes only and does not constitute legal advice. Consult with legal and regulatory experts for official guidance.
                </p>
            </div>
        </div>
    </div>

    <script>
        class DORAAssessment {
            constructor() {
                this.scores = {
                    step1: {},
                    step2: {},
                    overall: 0
                };
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('calculateBtn').addEventListener('click', () => this.calculateProbability());
                
                // Update progress bar as form is filled
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('change', () => this.updateProgress());
                });
            }

            updateProgress() {
                const inputs = document.querySelectorAll('input, select');
                const filled = Array.from(inputs).filter(input => input.value.trim() !== '').length;
                const progress = (filled / inputs.length) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }

            calculateProbability() {
                this.collectFormData();
                this.evaluateStep1Criteria();
                this.evaluateStep2Criteria();
                this.calculateOverallProbability();
                this.displayResults();
                this.generateRecommendations();
                this.createChart();
                
                // Scroll to results
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }

            collectFormData() {
                this.formData = {
                    companyName: document.getElementById('companyName').value,
                    primaryService: document.getElementById('primaryService').value,
                    creditInstitutions: parseInt(document.getElementById('creditInstitutions').value) || 0,
                    investmentFirms: parseInt(document.getElementById('investmentFirms').value) || 0,
                    insuranceCompanies: parseInt(document.getElementById('insuranceCompanies').value) || 0,
                    paymentInstitutions: parseInt(document.getElementById('paymentInstitutions').value) || 0,
                    totalAssets: parseFloat(document.getElementById('totalAssets').value) || 0,
                    marketSharePercent: parseFloat(document.getElementById('marketSharePercent').value) || 0,
                    gsiis: parseInt(document.getElementById('gsiis').value) || 0,
                    osiis: parseInt(document.getElementById('osiis').value) || 0,
                    highScoreOsii: document.getElementById('highScoreOsii').value,
                    systemicNonBank: parseInt(document.getElementById('systemicNonBank').value) || 0,
                    criticalFunctions: Array.from(document.querySelectorAll('input[name="criticalFunctions"]:checked')).map(cb => cb.value),
                    impactSpeed: document.getElementById('impactSpeed').value,
                    alternativeAvailability: document.getElementById('alternativeAvailability').value,
                    migrationDifficulty: document.getElementById('migrationDifficulty').value,
                    migrationTime: document.getElementById('migrationTime').value,
                    migrationCost: document.getElementById('migrationCost').value,
                    clientInterconnection: document.getElementById('clientInterconnection').value,
                    subcontractorDependency: document.getElementById('subcontractorDependency').value,
                    marketImpact: document.getElementById('marketImpact').value
                };
            }

            evaluateStep1Criteria() {
                // Domain 1: Systemic Impact (10% threshold)
                const marketShare = this.formData.marketSharePercent;
                const assetsThreshold = this.formData.totalAssets >= 50; // Simplified threshold
                this.scores.step1.systemicImpact = (marketShare >= 10 && assetsThreshold) ? 100 : 0;

                // Domain 2: Systemic Character
                const gsiiMet = this.formData.gsiis >= 1;
                const osiiMet = this.formData.osiis >= 3 || this.formData.highScoreOsii === 'yes';
                const systemicNonBankMet = this.formData.systemicNonBank >= 1;
                this.scores.step1.systemicCharacter = (gsiiMet || osiiMet || systemicNonBankMet) ? 100 : 0;

                // Domain 4: Substitutability (10% threshold based on difficulty)
                const lowAlternatives = ['0-10', '10-25'].includes(this.formData.alternativeAvailability);
                const highDifficulty = ['75-100', '50-75'].includes(this.formData.migrationDifficulty);
                this.scores.step1.substitutability = (lowAlternatives || highDifficulty) ? 100 : 0;

                // Step 1 must have ALL criteria met
                this.scores.step1.overall = (this.scores.step1.systemicImpact === 100 && 
                                           this.scores.step1.systemicCharacter === 100 && 
                                           this.scores.step1.substitutability === 100) ? 100 : 0;
            }

            evaluateStep2Criteria() {
                if (this.scores.step1.overall === 0) {
                    this.scores.step2.overall = 0;
                    return;
                }

                let qualitativeScore = 0;

                // Impact intensity
                const impactScores = {
                    'immediate': 25,
                    'hours': 20,
                    'days': 15,
                    'weeks': 10,
                    'minimal': 5
                };
                qualitativeScore += impactScores[this.formData.impactSpeed] || 0;

                // Interconnectedness
                const interconnectionScores = {
                    'high': 25,
                    'moderate': 15,
                    'low': 10,
                    'none': 5
                };
                qualitativeScore += interconnectionScores[this.formData.clientInterconnection] || 0;

                // Critical functions count
                qualitativeScore += Math.min(this.formData.criticalFunctions.length * 5, 25);

                // Market impact
                const marketImpactScores = {
                    'systemic': 25,
                    'sector': 20,
                    'regional': 15,
                    'limited': 10,
                    'minimal': 5
                };
                qualitativeScore += marketImpactScores[this.formData.marketImpact] || 0;

                this.scores.step2.overall = qualitativeScore;
            }

            calculateOverallProbability() {
                if (this.scores.step1.overall === 0) {
                    this.scores.overall = 0;
                    return;
                }

                // Base probability from step 2 qualitative assessment
                const baseProbability = Math.min(this.scores.step2.overall, 100);
                
                // Additional factors
                let modifiers = 0;
                
                // High systemic institution count
                if (this.formData.gsiis >= 2) modifiers += 10;
                if (this.formData.osiis >= 5) modifiers += 10;
                
                // Very high market share
                if (this.formData.marketSharePercent >= 20) modifiers += 15;
                if (this.formData.marketSharePercent >= 30) modifiers += 10;
                
                // Migration difficulty
                if (this.formData.migrationTime === 'years' || this.formData.migrationTime === 'very-difficult') {
                    modifiers += 10;
                }
                
                this.scores.overall = Math.min(baseProbability + modifiers, 100);
            }

            displayResults() {
                // Overall score
                document.getElementById('probabilityScore').textContent = `${this.scores.overall}%`;
                
                // Risk level
                let riskLevel, riskColor;
                if (this.scores.overall >= 80) {
                    riskLevel = 'VERY HIGH';
                    riskColor = 'text-red-600';
                } else if (this.scores.overall >= 60) {
                    riskLevel = 'HIGH';
                    riskColor = 'text-orange-600';
                } else if (this.scores.overall >= 40) {
                    riskLevel = 'MODERATE';
                    riskColor = 'text-yellow-600';
                } else if (this.scores.overall >= 20) {
                    riskLevel = 'LOW';
                    riskColor = 'text-blue-600';
                } else {
                    riskLevel = 'VERY LOW';
                    riskColor = 'text-green-600';
                }
                
                const riskElement = document.getElementById('riskLevel');
                riskElement.textContent = riskLevel;
                riskElement.className = `text-2xl font-bold ${riskColor}`;

                // Step 1 results
                this.displayStep1Results();
                
                // Step 2 results
                this.displayStep2Results();
            }

            displayStep1Results() {
                const step1Container = document.getElementById('step1Results');
                const criteria = [
                    {
                        name: 'Systemic Impact',
                        description: 'Market share ≥10% and significant assets under management',
                        passed: this.scores.step1.systemicImpact === 100,
                        details: `Market share: ${this.formData.marketSharePercent}%, Assets: €${this.formData.totalAssets}B`
                    },
                    {
                        name: 'Systemic Character',
                        description: 'Serves systemically important institutions',
                        passed: this.scores.step1.systemicCharacter === 100,
                        details: `G-SIIs: ${this.formData.gsiis}, O-SIIs: ${this.formData.osiis}, Other systemic: ${this.formData.systemicNonBank}`
                    },
                    {
                        name: 'Substitutability',
                        description: 'Limited alternatives or difficult migration',
                        passed: this.scores.step1.substitutability === 100,
                        details: `Alternatives: ${this.formData.alternativeAvailability || 'Not specified'}, Migration difficulty: ${this.formData.migrationDifficulty || 'Not specified'}`
                    }
                ];

                step1Container.innerHTML = criteria.map(criterion => `
                    <div class="flex items-center justify-between p-3 border rounded-lg ${criterion.passed ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <i class="fas ${criterion.passed ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600'} mr-2"></i>
                                <span class="font-medium">${criterion.name}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${criterion.description}</div>
                            <div class="text-xs text-gray-500 mt-1">${criterion.details}</div>
                        </div>
                        <div class="ml-4">
                            <span class="px-2 py-1 rounded text-xs font-medium ${criterion.passed ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                ${criterion.passed ? 'PASSED' : 'FAILED'}
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            displayStep2Results() {
                const step2Container = document.getElementById('step2Results');
                
                if (this.scores.step1.overall === 0) {
                    step2Container.innerHTML = `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="text-yellow-800">Step 2 assessment not applicable - Step 1 criteria not fully met</span>
                            </div>
                        </div>
                    `;
                    return;
                }

                const qualitativeFactors = [
                    {
                        name: 'Impact Speed',
                        value: this.formData.impactSpeed || 'Not specified',
                        score: this.getImpactSpeedScore()
                    },
                    {
                        name: 'Client Interconnection',
                        value: this.formData.clientInterconnection || 'Not specified',
                        score: this.getInterconnectionScore()
                    },
                    {
                        name: 'Critical Functions',
                        value: `${this.formData.criticalFunctions.length} functions`,
                        score: Math.min(this.formData.criticalFunctions.length * 5, 25)
                    },
                    {
                        name: 'Market Impact',
                        value: this.formData.marketImpact || 'Not specified',
                        score: this.getMarketImpactScore()
                    }
                ];

                step2Container.innerHTML = qualitativeFactors.map(factor => `
                    <div class="flex items-center justify-between p-3 border rounded-lg bg-blue-50 border-blue-200">
                        <div class="flex-1">
                            <div class="font-medium">${factor.name}</div>
                            <div class="text-sm text-gray-600">${factor.value}</div>
                        </div>
                        <div class="ml-4">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-blue-200 text-blue-800">
                                ${factor.score}/25 pts
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            getImpactSpeedScore() {
                const scores = { 'immediate': 25, 'hours': 20, 'days': 15, 'weeks': 10, 'minimal': 5 };
                return scores[this.formData.impactSpeed] || 0;
            }

            getInterconnectionScore() {
                const scores = { 'high': 25, 'moderate': 15, 'low': 10, 'none': 5 };
                return scores[this.formData.clientInterconnection] || 0;
            }

            getMarketImpactScore() {
                const scores = { 'systemic': 25, 'sector': 20, 'regional': 15, 'limited': 10, 'minimal': 5 };
                return scores[this.formData.marketImpact] || 0;
            }

            generateRecommendations() {
                const recommendationsContainer = document.getElementById('recommendations');
                const recommendations = [];

                if (this.scores.overall >= 60) {
                    recommendations.push({
                        type: 'warning',
                        icon: 'fa-exclamation-triangle',
                        title: 'High Designation Risk',
                        text: 'Your organization has a high probability of CTPP designation. Begin preparation for potential oversight requirements immediately.'
                    });
                    
                    recommendations.push({
                        type: 'info',
                        icon: 'fa-clipboard-check',
                        title: 'Regulatory Compliance Preparation',
                        text: 'Start developing governance frameworks, risk management procedures, and incident reporting capabilities required for CTPPs.'
                    });
                }

                if (this.scores.step1.overall === 0) {
                    recommendations.push({
                        type: 'success',
                        icon: 'fa-shield-alt',
                        title: 'Currently Below Thresholds',
                        text: 'Your organization currently does not meet the quantitative thresholds for CTPP designation. Monitor these metrics as your business grows.'
                    });
                }

                if (this.formData.gsiis > 0 || this.formData.osiis >= 3) {
                    recommendations.push({
                        type: 'warning',
                        icon: 'fa-university',
                        title: 'Systemic Institution Exposure',
                        text: 'Your service to systemically important institutions significantly increases designation risk. Consider the regulatory implications in business planning.'
                    });
                }

                if (this.scores.step1.substitutability === 100) {
                    recommendations.push({
                        type: 'info',
                        icon: 'fa-exchange-alt',
                        title: 'Limited Substitutability',
                        text: 'The difficulty for clients to switch providers increases your systemic importance. Consider how this affects your regulatory obligations.'
                    });
                }

                // Default recommendation
                if (recommendations.length === 0) {
                    recommendations.push({
                        type: 'info',
                        icon: 'fa-chart-line',
                        title: 'Monitor Key Metrics',
                        text: 'Continue monitoring your market position, client base, and service criticality as these factors can change over time.'
                    });
                }

                recommendationsContainer.innerHTML = recommendations.map(rec => {
                    const colors = {
                        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                        info: 'bg-blue-50 border-blue-200 text-blue-800',
                        success: 'bg-green-50 border-green-200 text-green-800'
                    };
                    
                    return `
                        <div class="p-4 border rounded-lg ${colors[rec.type]}">
                            <div class="flex items-start">
                                <i class="fas ${rec.icon} mt-1 mr-3"></i>
                                <div>
                                    <div class="font-semibold mb-1">${rec.title}</div>
                                    <div class="text-sm">${rec.text}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            createChart() {
                const ctx = document.getElementById('probabilityChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.myChart) {
                    window.myChart.destroy();
                }

                const data = {
                    labels: ['Step 1: Quantitative', 'Step 2: Qualitative', 'Overall Risk'],
                    datasets: [{
                        label: 'Score',
                        data: [
                            this.scores.step1.overall,
                            this.scores.step2.overall,
                            this.scores.overall
                        ],
                        backgroundColor: [
                            this.scores.step1.overall === 100 ? '#22c55e' : '#ef4444',
                            '#3b82f6',
                            this.scores.overall >= 60 ? '#ef4444' : this.scores.overall >= 40 ? '#eab308' : '#22c55e'
                        ],
                        borderColor: [
                            this.scores.step1.overall === 100 ? '#16a34a' : '#dc2626',
                            '#2563eb',
                            this.scores.overall >= 60 ? '#dc2626' : this.scores.overall >= 40 ? '#ca8a04' : '#16a34a'
                        ],
                        borderWidth: 2
                    }]
                };

                window.myChart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'CTPP Designation Assessment Breakdown'
                            }
                        }
                    }
                });
            }
        }

        // Initialize the assessment tool
        document.addEventListener('DOMContentLoaded', function() {
            new DORAAssessment();
        });
    </script>
</body>
</html>
